<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GovQueue - Public Display</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #0D1321;
      color: #F0EBd8;
      margin: 0;
    }

    nav {
      background-color: #1D2D44;
      color: #F0EBD8;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 25px;
      position: sticky;
      top: 0;
      z-index: 10000;
    }

    nav .logo {
      font-size: 1.6rem;
      font-weight: bold;
    }

    nav ul {
      list-style: none;
      display: flex;
      margin: 0;
      padding: 0;
    }

    nav ul li {
      margin-left: 20px;
    }

    nav ul li a {
      text-decoration: none;
      color: #F0EBd8;
      font-weight: 500;
    }

    nav ul li a:hover {
      color: #748CAB;
    }

    .container {
      margin-top: 50px;
    }

    h1 {
      text-align: center;
      margin-bottom: 40px;
      color: #F0EBd8;
    }

    .service-card {
      background-color: #1D2D44;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      color: #F0EBd8;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
      min-height: 150px;
    }

    .service-card h3 {
      margin-bottom: 10px;
    }

    .service-card p {
      font-size: 1.2rem;
      margin: 5px 0;
    }

    .serving-token {
      font-size: 2rem;
      font-weight: bold;
      color: #748CAB;
    }

    .footer-bottom {
      text-align: center;
      padding: 15px;
      background: #1D2D44;
      color: #F0EBD8;
      margin-top: 30px;
    }

    #announcement-banner {
      background-color: #ffc107;
      color: #333;
      text-align: center;
      padding: 15px;
      font-weight: bold;
      border-radius: 8px;
      margin-bottom: 25px;
      border: 1px solid #e0a800;
    }
  </style>
</head>

<body>

  <nav>
    <div class="logo">GovQueue</div>
    <ul id="nav-links-public">
      <li><a href="index.html">Home</a></li>
      <li><a href="login.html">Login</a></li>
      <li><a href="signup.html">Signup</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li><a href="reqd_docs.html">Required Documents</a></li>
    </ul>
  </nav>

  <div class="container">
    <h1>GovQueue - Live Queue Status</h1>
    <div class="row row-cols-1 row-cols-md-3 g-4" id="servicesContainer">
    </div>
  </div>

  <div class="footer-bottom">
    <span id="live-clock"></span> | &copy; 2025 GovQueue | All Rights Reserved
  </div>

  <script src="../JS/main.js"></script>
  <script>
    // This script dynamically changes the navbar links if a user is logged in
    document.addEventListener('DOMContentLoaded', () => {
      const navLinks = document.getElementById('nav-links-public');
      const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

      if (loggedInUser && loggedInUser.name) {
        // If logged in, show dashboard and logout links
        navLinks.innerHTML = `
                <li><span class="navbar-text text-white me-3">Welcome, ${loggedInUser.name}</span></li>
                <li><a href="user_dashboard.html">Dashboard</a></li>
                <li><a href="#" onclick="localStorage.clear(); window.location.href='login.html';">Logout</a></li>
            `;
      }
      // If not logged in, the default HTML links will be shown.
    });

    // This script handles the public display logic
    const servicesContainer = document.getElementById('servicesContainer');
    const serviceNames = ["Aadhar Card", "Voter ID", "Passport", "Driving License", "PAN Card", "Ration Card", "Birth Certificate", "Marriage Certificate", "Income Certificate", "Caste Certificate"];

    function renderCards(publicData) {
      servicesContainer.innerHTML = '';
      serviceNames.forEach(serviceName => {
        const serviceInfo = publicData[serviceName];
        const status = serviceInfo ? serviceInfo.staffStatus : 'Offline';
        const statusColor = status === 'Active' ? 'text-success' : (status === 'Break' ? 'text-warning' : 'text-danger');
        let cardContent;

        if (serviceInfo && serviceInfo.totalInQueue > 0) {
          cardContent = `
                    <h3>${serviceName}</h3>
                    <p>Counter Status: <strong class="fs-5 ${statusColor}">${status}</strong></p>
                    <p>Total in Queue: ${serviceInfo.totalInQueue}</p>
                    <p>Now Serving: <span class="serving-token">#${serviceInfo.currentlyServing}</span></p>
                `;
        } else {
          cardContent = `
                    <h3>${serviceName}</h3>
                    <p>Counter Status: <strong class="fs-5 ${statusColor}">${status}</strong></p>
                    <p>No tokens in queue for today.</p>
                `;
        }

        const card = `<div class="col"><div class="service-card">${cardContent}</div></div>`;
        servicesContainer.innerHTML += card;
      });
    }

    async function fetchAndUpdateDisplay() {
      try {
        const res = await fetch('http://localhost:3000/api/tokens/public');
        const data = await res.json();
        if (data.success) {
          renderCards(data.publicData);
        }
      } catch (err) {
        console.error("Could not fetch token data:", err);
        servicesContainer.innerHTML = '<p style="text-align:center;">Could not connect to the server.</p>';
      }
    }

    // The 'socket' variable is created in main.js, so we can use it here
    socket.on('tokenUpdated', fetchAndUpdateDisplay);
    socket.on('newToken', fetchAndUpdateDisplay);
    socket.on('staffStatusUpdated', fetchAndUpdateDisplay);

    fetchAndUpdateDisplay();
  </script>

</body>

</html>